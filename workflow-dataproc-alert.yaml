# Eventarc, Workflows 2 Slack
# Eventarc, google.cloud.dataproc.v1.ClusterController.DeleteCluster triggers a Workflow
# Workflows, check job status > send a slack message if it equals ERROR
main:
    params: [input]
    steps:
    - assignArgs:
            assign:
            - projectID: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
            - response: ${input}
            - jobId: ${"step-spark-postgresql-2-bigquery-" + text.substring(response.data.resource.labels.cluster_name, 36, 49)}
    - checkOperation:
            switch:
                - condition: ${"first" in response.data.operation}
                  next: getJob
            next: returnOutput
    - getJob:
            call: http.get
            args:
                auth:
                    type: OAuth2
                    scopes: https://www.googleapis.com/auth/cloud-platform
                url: ${"https://dataproc.googleapis.com/v1/projects/" + projectID + "/regions/asia-northeast1/jobs/" + jobId}
            result: response
    - checkStatus:
            switch:
                - condition: ${response.body.status.state == "ERROR"}
                  next: sendSlack
            next: returnOutput
    - sendSlack:
            call: http.post
            args:
                headers: {Content-type: application/json, Authorization: Bearer xoxb-your-token}
                url: https://slack.com/api/chat.postMessage
                body: { "channel": "C04CTKH1JBZ", "text": '${"https://console.cloud.google.com/dataproc/jobs/" + jobId + "?region=asia-northeast1&project=" + projectID}'}
    - returnOutput:
            return: ${response}
